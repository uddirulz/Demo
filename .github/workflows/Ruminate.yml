name: pull

on:
 workflow_dispatch
 
jobs:
  container-test-job:
   runs-on: ubuntu-latest
   container:
    image: uddirulz/clockbox:latest
    options: --name=jmeter_cont
    credentials:
     username: ${{ secrets.DOCKERHUB_USERNAME }}
     password: ${{ secrets.DOCKERHUB_TOKEN }}
     
   steps:
   - name: Print something
     id: setup
     run: |
      jmeter --version
      cd ${JMETER_HOME}
      ls
      pwd
      echo "date1=$(date +"%Y-%m-%d")" >> $GITHUB_OUTPUT
   - name: Checkout
     uses: actions/checkout@v3
   - run: |
           ls
           printenv
   - name: Run JMTR Test
     run: jmeter.sh -n -t Dummy.jmx -l "${{steps.setup.outputs.date1}}_res.csv"
   - name: Parse Junit XML
     run: python JunitParser.py
   - name: Junit
     id: junit_parser
     run: echo "count=$(grep -io "failure message" Test-Performance.xml | wc -l)" >> "$GITHUB_OUTPUT"
   - name: Validate JUNIT
     if: ${{steps.junit_parser.outputs.*}} > 0
     run: exit 1
   - uses: actions/upload-artifact@v3
     with:
      name: my-artifact
      path: res.csv
     
